<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Carte des Points Relais Lille</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 80vh; width: 100%; margin-top: 1em; }
    .leaflet-routing-container { background: white; border-radius: 0.5em; }
    :root {
      --bg: #ffffff;
      --fg: #121212;
      --card: #f4f4f5;
      --border: #e5e7eb;
    }
    html[data-theme="dark"] body { background:#0b0b0c; color:#ececec; }
    html[data-theme="dark"] .container { color:#ececec; }
    html[data-theme="dark"] .leaflet-control,
    html[data-theme="dark"] .leaflet-popup-content-wrapper,
    html[data-theme="dark"] .leaflet-popup-tip {
      background:#1d1f24; color:#ececec; border-color:#2a2d33;
    }
  </style>
</head>
<body>
  <script>
    const _media = window.matchMedia('(prefers-color-scheme: dark)');
    const _apply = () => document.documentElement.setAttribute('data-theme', _media.matches ? 'dark' : 'light');
    _apply();
    _media.addEventListener('change', _apply);
  </script>
  <div class="container">
    <div class="d-flex align-items-center gap-2 mt-3">
      <a href="index.html" class="btn btn-outline-secondary" title="Retour √† l'accueil">üè† Accueil</a>
      <h1 class="m-0">Carte des Points Relais Lille</h1>
    </div>
    <p>
      Ce service agr√®ge les points relais (Mondial Relay, Amazon Lockers, Relais Colis, etc.) √† partir d‚ÄôOpenStreetMap.
      <strong>Les donn√©es ne sont pas exhaustives et peuvent comporter des erreurs‚ÄØ; utilisez-les √† titre indicatif.</strong>
      G√©olocalise-toi et choisis ton point relais pour un itin√©raire pi√©ton.
    </p>
    <button class="btn btn-primary" id="locateBtn">Me g√©olocaliser</button>
    <div id="map"></div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script>
    const map = L.map('map').setView([50.62925, 3.057256], 13); // Centre Lille

    // Fond de carte
    L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap',
      maxZoom: 19
    }).addTo(map);

    // R√©cup√®re les points relais depuis l‚ÄôAPI Overpass (Lille)
    async function getParcelPoints() {
      // Requ√™te : points relais/lockers/colis/autres √† Lille
      const query = `
        [out:json][timeout:25];
        (
          node
            ["amenity"="parcel_locker"]
            (50.58,3.02,50.66,3.10);   // Approx bbox Lille
          node
            ["shop"="parcel_pickup"]
            (50.58,3.02,50.66,3.10);
        );
        out body;
      `;
      const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
      return (await response.json()).elements;
    }

    let myMarker = null;

    // Ajoute les points relais sur la carte
    getParcelPoints().then(points => {
      points.forEach(p => {
        const brand = p.tags.brand || p.tags.operator || "Point Relais";
        const popup = `<strong>${brand}</strong><br>
          ${p.tags.name || ""}<br>
          Adresse: ${p.tags["addr:street"] || ""}, ${p.tags["addr:housenumber"] || ""}<br>
          <button class="btn btn-sm btn-success" onclick="routeTo([${p.lat},${p.lon}])">Itin√©raire pi√©ton ici</button>`;
        L.marker([p.lat, p.lon]).addTo(map).bindPopup(popup);
      });
    });

    // G√©olocalisation utilisateur
    document.getElementById('locateBtn').onclick = () => {
      if (!navigator.geolocation) return alert("La g√©olocalisation n'est pas support√©e !");
      navigator.geolocation.getCurrentPosition(pos => {
        const {latitude, longitude} = pos.coords;
        if (myMarker) map.removeLayer(myMarker);
        myMarker = L.marker([latitude, longitude], {color: "blue"}).addTo(map)
          .bindPopup("Votre position").openPopup();
        map.setView([latitude, longitude], 15);
      }, err => {
        alert("Impossible de vous localiser.");
      });
    };

    // Trac√© d‚Äôitin√©raire pi√©ton (Leaflet Routing Machine + OSRM)
    window.routeTo = function(dest) {
      if (!myMarker) return alert("Cliquez sur : 'Me g√©olocaliser' d'abord !");
      if (window.routingControl) map.removeControl(window.routingControl);
      const start = myMarker.getLatLng();
      window.routingControl = L.Routing.control({
        waypoints: [
          L.latLng(start.lat, start.lng),
          L.latLng(dest[0], dest[1])
        ],
        lineOptions: { styles: [{ color: 'green', weight: 5 }] },
        router: new L.Routing.OSRMv1({
          profile: 'foot'
        }),
        show: true,
        routeWhileDragging: false,
        language: 'fr'
      }).addTo(map);
    }
  </script>
</body>
</html>
