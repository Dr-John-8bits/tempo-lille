

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Air de Lille â€“ QualitÃ© de lâ€™air & MÃ©tÃ©o rapide</title>
  <meta name="description" content="QualitÃ© de lâ€™air (EAQI), pluie dans lâ€™heure/la journÃ©e, tempÃ©ratures â€“ Lille ou position actuelle. Design Bootstrap, responsive." />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --ok:#16a34a;   /* vert */
      --mod:#f59e0b;  /* orange */
      --bad:#ef4444;  /* rouge */
      --vbad:#9333ea; /* violet */
      --bg: #f8fafc;
    }
    body{ background: var(--bg); }
    .sticky-top-blur{ backdrop-filter: saturate(140%) blur(8px); }
    .chip{display:inline-flex;align-items:center;gap:.45rem;padding:.42rem .65rem;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.6);}
    .card-soft{ border:0; border-radius:1rem; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    .card-soft .card-header{ background:#fff; border-top-left-radius:1rem; border-top-right-radius:1rem; border-bottom:1px solid rgba(0,0,0,.06) }
    .big{ font-size:clamp(1.4rem, 4vw, 2.2rem); font-weight:800; }
    .sub{ color:#6b7280 }
    .muted{ color:#6c757d }
    .grid{ display:grid; grid-template-columns:1fr; gap:1rem }
    @media (min-width: 700px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .skeleton{background:linear-gradient(90deg,#eee,#f8f9fa,#eee);background-size:200% 100%;animation:sh 1.1s infinite}
    @keyframes sh{to{background-position:-200% 0}}
    .legend{display:flex;gap:.4rem;flex-wrap:wrap}
    .legend .box{width:18px;height:12px;border-radius:3px;display:inline-block}
    .badge-dot{display:inline-flex;align-items:center;gap:.35rem}
    .badge-dot::before{content:"";width:.55rem;height:.55rem;border-radius:50%;display:inline-block;background:currentColor}
  </style>
</head>
<body>
  <!-- Header -->
  <nav class="navbar sticky-top sticky-top-blur bg-white/75 shadow-sm">
    <div class="container-fluid px-3 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <a href="index.html" class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1"><i class="bi bi-arrow-left"></i> Accueil</a>
        <span class="navbar-brand fw-bold d-flex align-items-center gap-2 mb-0"><i class="bi bi-wind"></i> Air de Lille</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button id="btnLocate" class="btn btn-outline-secondary btn-sm"><i class="bi bi-geo"></i> Autour de moi</button>
        <button id="btnRefresh" class="btn btn-outline-primary btn-sm"><i class="bi bi-arrow-clockwise"></i> Actualiser</button>
      </div>
    </div>
  </nav>

  <main class="container py-3 py-md-4">
    <!-- Bandeau message & Ã©tat -->
    <section class="mb-3">
      <div id="mood" class="alert d-flex align-items-center justify-content-between" role="status">
        <div class="d-flex align-items-center gap-2">
          <span id="moodIcon" class="fs-4">ğŸ˜¶â€ğŸŒ«ï¸</span>
          <div>
            <div id="moodText" class="fw-semibold">Chargementâ€¦</div>
            <div id="locText" class="small text-secondary">â€”</div>
          </div>
        </div>
        <span id="lastUpdate" class="small text-secondary">â€”</span>
      </div>
    </section>

    <section class="grid">
      <!-- AQI -->
      <div class="card card-soft">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-cloud-haze2 fs-5"></i>
            <strong>QualitÃ© de lâ€™air (EAQI)</strong>
          </div>
          <span id="aqiBadge" class="badge text-bg-secondary">â€”</span>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-baseline gap-3 mb-2">
            <div id="aqiValue" class="big">â€”</div>
            <div id="aqiLabel" class="fs-5">â€”</div>
          </div>
          <div class="legend mb-2">
            <span class="box" style="background:#2ecc71" title="TrÃ¨s bon"></span>
            <span class="box" style="background:#8bc34a" title="Bon"></span>
            <span class="box" style="background:#f1c40f" title="Moyen"></span>
            <span class="box" style="background:#ff9800" title="MÃ©diocre"></span>
            <span class="box" style="background:#e74c3c" title="Mauvais"></span>
            <span class="box" style="background:#8e44ad" title="TrÃ¨s mauvais"></span>
          </div>
          <div class="row g-2">
            <div class="col-6 col-md-4"><div class="chip w-100"><span class="badge-dot" style="color:#111">PM2.5</span><span id="pm25">â€”</span> Âµg/mÂ³</div></div>
            <div class="col-6 col-md-4"><div class="chip w-100"><span class="badge-dot" style="color:#444">PM10</span><span id="pm10">â€”</span> Âµg/mÂ³</div></div>
            <div class="col-6 col-md-4"><div class="chip w-100"><span class="badge-dot" style="color:#0d6efd">Oâ‚ƒ</span><span id="o3">â€”</span> Âµg/mÂ³</div></div>
            <div class="col-6 col-md-4"><div class="chip w-100"><span class="badge-dot" style="color:#e11d48">NOâ‚‚</span><span id="no2">â€”</span> Âµg/mÂ³</div></div>
          </div>
        </div>
      </div>

      <!-- MÃ©tÃ©o rapide -->
      <div class="card card-soft">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-umbrella fs-5"></i>
            <strong>MÃ©tÃ©o rapide</strong>
          </div>
          <span id="rainBadge" class="badge text-bg-secondary">â€”</span>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-baseline gap-3 mb-2">
            <div id="tempNow" class="big">â€”Â°C</div>
            <div class="sub">Max <span id="tMax">â€”</span>Â° Â· Min <span id="tMin">â€”</span>Â°</div>
          </div>
          <div class="row g-2">
            <div class="col-12 col-md-6"><div class="chip w-100"><i class="bi bi-clock-history"></i> Pluie dans lâ€™heure : <strong id="rainHour">â€”</strong></div></div>
            <div class="col-12 col-md-6"><div class="chip w-100"><i class="bi bi-calendar-day"></i> Pluie aujourdâ€™hui : <strong id="rainDay">â€”</strong></div></div>
            <div class="col-12 col-md-6"><div class="chip w-100"><i class="bi bi-droplet"></i> Prob. prÃ©cip. (prochaine heure) : <strong id="popHour">â€”</strong></div></div>
            <div class="col-12 col-md-6"><div class="chip w-100"><i class="bi bi-wind"></i> Vent : <strong id="wind">â€”</strong></div></div>
          </div>
        </div>
      </div>
    </section>

    <section class="text-center mt-4">
      <p class="text-secondary small mb-1">Sources : Openâ€‘Meteo (Forecast & Air Quality, CAMS). Estimations automatiques, donnÃ©es sans garantie.</p>
      <p class="text-secondary small">Cette page est nonâ€‘officielle. Aucun cookie. Vos prÃ©fÃ©rences restent sur lâ€™appareil.</p>
    </section>
  </main>

  <!-- Toast error -->
  <div class="position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index:1080">
    <div id="toastErr" class="toast text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Impossible de rÃ©cupÃ©rer les donnÃ©es. RÃ©essaie plus tard.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
      </div>
    </div>
  </div>

  <script>
    // ====== Config & helpers ======
    const DEFAULT_LOC = { name: 'Lille', lat: 50.62925, lon: 3.057256 };

    const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const el  = (sel, root=document) => root.querySelector(sel);

    const fmtTime = (d) => new Date(d).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    const clamp = (n,min,max)=> Math.max(min, Math.min(max,n));

    // EAQI palette & labels (approx.)
    function aqiBand(aqi){
      if (aqi == null || isNaN(aqi)) return {label:'â€”', color:'#9aa0a6', bg:'#eceff1'};
      if (aqi <= 20)  return {label:'TrÃ¨s bon',  color:'#1b5e20', bg:'#c8f7dc'};
      if (aqi <= 40)  return {label:'Bon',       color:'#2e7d32', bg:'#e1f5e9'};
      if (aqi <= 60)  return {label:'Moyen',     color:'#7b5e00', bg:'#fff3cd'};
      if (aqi <= 80)  return {label:'MÃ©diocre',  color:'#b45309', bg:'#ffe4c7'};
      if (aqi <= 100) return {label:'Mauvais',   color:'#9b1c1c', bg:'#ffe2e2'};
      return {label:'TrÃ¨s mauvais', color:'#6b21a8', bg:'#efe2ff'};
    }

    function moodMessage(aqi, rainSoon){
      const { label } = aqiBand(aqi);
      const map = {
        'TrÃ¨s bon': rainSoon ? 'Air nickel, ciel capricieux â€” prends un k-way.' : 'Respire fort, câ€™est clean aujourdâ€™hui.',
        'Bon':       rainSoon ? 'Bon air, une averse se prÃ©pare.' : 'Bon bol dâ€™air â€” profite pour sortir.',
        'Moyen':     rainSoon ? 'Air moyen + pluie probable. AÃ¨re court, garde un Å“il au ciel.' : 'Air moyen â€” aÃ¨re briÃ¨vement, pas dâ€™excÃ¨s.',
        'MÃ©diocre':  rainSoon ? 'QualitÃ© mÃ©diocre et pluie possible. FenÃªtre en mode â€œpetite pauseâ€.' : 'QualitÃ© mÃ©diocre â€” Ã©vite dâ€™aÃ©rer trop longtemps.',
        'Mauvais':   rainSoon ? 'Air mauvais + pluie. Garde les fenÃªtres fermÃ©es.' : 'Air mauvais â€” ferme la fenÃªtre.',
        'TrÃ¨s mauvais': rainSoon ? 'Air trÃ¨s mauvais. Reste Ã  lâ€™abri, Ã©vite lâ€™effort.' : 'Air trÃ¨s mauvais â€” Ã©vite lâ€™effort dehors.'
      };
      return map[label] || 'Conditions en cours dâ€™Ã©valuationâ€¦';
    }

    function setMoodUI(aqi){
      const band = aqiBand(aqi);
      document.body.style.setProperty('--bg', band.bg);
      const mood = el('#mood');
      mood.className = 'alert d-flex align-items-center justify-content-between';
      mood.style.background = band.bg;
      mood.style.border = '1px solid rgba(0,0,0,.06)';
    }

    // ====== Fetchers ======
    async function fetchWeather(lat, lon){
      const url = new URL('https://api.open-meteo.com/v1/forecast');
      url.searchParams.set('latitude', lat);
      url.searchParams.set('longitude', lon);
      url.searchParams.set('hourly', 'temperature_2m,precipitation_probability,precipitation,wind_speed_10m');
      url.searchParams.set('current', 'temperature_2m,precipitation,wind_speed_10m');
      url.searchParams.set('daily', 'temperature_2m_max,temperature_2m_min,precipitation_sum');
      url.searchParams.set('timezone', 'Europe/Paris');
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('weather');
      return res.json();
    }

    async function fetchAir(lat, lon){
      const url = new URL('https://air-quality-api.open-meteo.com/v1/air-quality');
      url.searchParams.set('latitude', lat);
      url.searchParams.set('longitude', lon);
      url.searchParams.set('hourly', 'european_aqi,pm2_5,pm10,ozone,nitrogen_dioxide');
      url.searchParams.set('timezone', 'Europe/Paris');
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('air');
      return res.json();
    }

    function nearestIndex(timesISO){
      const now = Date.now();
      let best = 0, bestDiff = Infinity;
      timesISO.forEach((t,i)=>{ const d = Math.abs(new Date(t).getTime() - now); if (d < bestDiff){ best=i; bestDiff=d; } });
      return best;
    }

    function updateWeatherUI(json){
      const c = json.current || {};
      el('#tempNow').textContent = Math.round(c.temperature_2m ?? NaN) + 'Â°C';
      const d = json.daily || {};
      el('#tMax').textContent = Math.round((d.temperature_2m_max?.[0]) ?? NaN);
      el('#tMin').textContent = Math.round((d.temperature_2m_min?.[0]) ?? NaN);

      // Next hour rain signal
      const h = json.hourly || {};
      const idx = nearestIndex(h.time || []);
      const probNow  = Number(h.precipitation_probability?.[idx] ?? 0);
      const probNext = Number(h.precipitation_probability?.[idx+1] ?? probNow);
      const precNow  = Number(h.precipitation?.[idx] ?? 0);
      const precNext = Number(h.precipitation?.[idx+1] ?? 0);
      const rainSoon = (probNow >= 50 || probNext >= 50 || precNow > 0 || precNext > 0);
      el('#rainHour').textContent = rainSoon ? 'Probable' : 'Peu probable';
      el('#popHour').textContent = clamp(Math.max(probNow, probNext),0,100) + ' %';

      // Rain today?
      const dayPrec = Number(d.precipitation_sum?.[0] ?? 0);
      el('#rainDay').textContent = dayPrec > 0 ? 'Oui' : 'Non';

      // Wind
      const wind = Number(h.wind_speed_10m?.[idx] ?? c.wind_speed_10m ?? 0);
      el('#wind').textContent = `${Math.round(wind)} km/h`;

      // Badge quick state
      const rainBadge = el('#rainBadge');
      rainBadge.className = 'badge ' + (rainSoon ? 'text-bg-warning' : 'text-bg-success');
      rainBadge.textContent = rainSoon ? 'Pluie possible' : 'Sec Ã  court terme';

      return { rainSoon };
    }

    function updateAirUI(json){
      const h = json.hourly || {};
      const idx = nearestIndex(h.time || []);
      const aqi = Number(h.european_aqi?.[idx]);
      const band = aqiBand(aqi);
      el('#aqiValue').textContent = isFinite(aqi) ? Math.round(aqi) : 'â€”';
      el('#aqiLabel').textContent = band.label;
      const aqiBadge = el('#aqiBadge');
      aqiBadge.className = 'badge';
      aqiBadge.style.backgroundColor = band.bg;
      aqiBadge.style.color = '#111';
      aqiBadge.textContent = band.label;

      // Pollutants
      const p = (arr)=>{ const v = Number(arr?.[idx]); return isFinite(v) ? Math.round(v) : 'â€”'; };
      el('#pm25').textContent = p(h.pm2_5);
      el('#pm10').textContent = p(h.pm10);
      el('#o3').textContent   = p(h.ozone);
      el('#no2').textContent  = p(h.nitrogen_dioxide);

      setMoodUI(aqi);
      return { aqi };
    }

    async function load(loc){
      try{
        el('#moodText').textContent = 'Chargementâ€¦';
        const [w, a] = await Promise.all([ fetchWeather(loc.lat, loc.lon), fetchAir(loc.lat, loc.lon) ]);
        const { rainSoon } = updateWeatherUI(w);
        const { aqi } = updateAirUI(a);

        // Mood block
        el('#moodIcon').textContent = rainSoon ? 'ğŸŒ¦ï¸' : 'ğŸŒ¤ï¸';
        el('#moodText').textContent = moodMessage(aqi, rainSoon);
        el('#locText').textContent  = `${loc.name} â€¢ ${fmtTime(new Date())}`;
        el('#lastUpdate').textContent = 'DerniÃ¨re mise Ã  jour : ' + fmtTime(new Date());
      }catch(err){
        console.error(err);
        const toast = bootstrap.Toast.getOrCreateInstance(document.getElementById('toastErr'));
        toast.show();
      }
    }

    // ====== Geoloc & events ======
    function resolveLocation(){
      return new Promise((resolve)=>{
        if (!('geolocation' in navigator)) return resolve(DEFAULT_LOC);
        navigator.geolocation.getCurrentPosition((pos)=>{
          resolve({ name:'Position actuelle', lat: pos.coords.latitude, lon: pos.coords.longitude });
        }, ()=> resolve(DEFAULT_LOC), { enableHighAccuracy:true, timeout:8000, maximumAge:30000 });
      });
    }

    document.getElementById('btnRefresh').addEventListener('click', async ()=>{
      const loc = await resolveLocation();
      load(loc);
    });

    document.getElementById('btnLocate').addEventListener('click', async ()=>{
      const loc = await resolveLocation();
      load(loc);
    });

    document.addEventListener('DOMContentLoaded', async ()=>{
      const loc = await resolveLocation();
      await load(loc);
      // auto-refresh every 10 minutes
      setInterval(async ()=>{ const l = await resolveLocation(); load(l); }, 10*60*1000);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>