

<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vite un Citiz !</title>
  <meta name="description" content="Disponibilit√© en temps r√©el des stations Citiz (autopartage) ‚Äî favoris, recherche, th√®me auto, sans rechargement." />
  <!-- Favicon & PWA meta -->
  <link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="9" width="18" height="6" rx="2" ry="2" fill="none" stroke="%23000" stroke-width="2"/><circle cx="7" cy="17" r="3" fill="none" stroke="%23000" stroke-width="2"/><circle cx="17" cy="17" r="3" fill="none" stroke="%23000" stroke-width="2"/><path d="M6 9 L8 7 H16 L18 9" fill="none" stroke="%23000" stroke-width="2" stroke-linecap="round"/></svg>'>
  <meta name="theme-color" content="#0d6efd" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Vite un Citiz !" />
  <style>
    :root {
      --bg: #ffffff;
      --fg: #121212;
      --muted: #5a5a5a;
      --card: #f4f4f5;
      --accent: #0d6efd;
      --ok: #16a34a;
      --warn: #f59e0b;
      --bad: #ef4444;
      --border: #e5e7eb;
      --shadow: 0 1px 2px rgba(0,0,0,.06), 0 4px 12px rgba(0,0,0,.04);
    }
    html[data-theme="dark"] { --bg:#0b0b0c; --fg:#ececec; --muted:#b3b3b3; --card:#151518; --accent:#7aa2ff; --border:#22242a; --shadow:0 1px 2px rgba(0,0,0,.4), 0 6px 20px rgba(0,0,0,.25); }

    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--fg); overflow-x:hidden; }

    header { position: sticky; top:0; z-index:10; backdrop-filter: blur(6px); background: color-mix(in oklab, var(--bg) 85%, transparent); border-bottom:1px solid var(--border); }
    .bar { max-width: 900px; margin:0 auto; padding:.8rem 1rem; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .logoCar { width:24px; height:24px; margin-right:.4rem; display:inline-block; stroke:var(--fg); fill:none; stroke-width:1.8; stroke-linecap:round; stroke-linejoin:round; }
    .title { font-weight:800; letter-spacing:.2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:46vw; }
    .spacer { flex:1; }
    .pill { display:inline-flex; align-items:center; gap:.4rem; font-size:.9rem; padding:.35rem .6rem; border:1px solid var(--border); border-radius:999px; background:var(--card); }
    .btn { appearance:none; border:1px solid var(--border); padding:.55rem .8rem; background:var(--card); color:var(--fg); border-radius:.7rem; box-shadow:var(--shadow); cursor:pointer; }

    .banner { display:none; background: color-mix(in oklab, var(--bad) 18%, var(--bg)); color:var(--fg); border-bottom:1px solid var(--border); }
    .banner .wrap { max-width:900px; margin:0 auto; padding:.5rem 1rem; display:flex; align-items:center; gap:.6rem; }

    .filters { position: sticky; top: calc(var(--header-h, 56px)); z-index: 6; background: var(--bg); border-bottom: 1px solid var(--border); padding: .5rem 1rem; display: flex; gap: .4rem; justify-content: center; }
    .seg { appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--fg); padding: .45rem .8rem; border-radius: 999px; cursor: pointer; font: inherit; }
    .seg[aria-selected="true"] { outline: 2px solid var(--accent); }

    .ptr { display:none; background: color-mix(in oklab, var(--accent) 12%, var(--bg)); border-bottom: 1px solid var(--border); }
    .ptr .wrap { max-width:900px; margin:0 auto; padding:.4rem 1rem; font-size:.9rem; }
    .ptr.show { display:block; }

    main { max-width:900px; margin:0 auto; padding:1rem; }

    .search { position: sticky; top: calc(var(--header-h, 56px) + 48px); z-index:5; background:var(--bg); padding:.6rem 0 .8rem; }
    .search .wrap { position:relative; }
    .suggestions { position:absolute; left:0; right:0; top:100%; margin-top:.25rem; background:var(--card); border:1px solid var(--border); border-radius:.7rem; box-shadow:var(--shadow); list-style:none; padding:.25rem 0; max-height:280px; overflow:auto; }
    .suggestions[hidden]{ display:none; }
    .suggestions li { padding:.55rem .9rem; cursor:pointer; }
    .suggestions li:hover{ background: color-mix(in oklab, var(--card) 80%, var(--accent) 20%); }

    .list { display:grid; grid-template-columns:1fr; gap:.8rem; }
    @media (min-width:640px){ .list { grid-template-columns:1fr 1fr; } }

    .card { background:var(--card); border:1px solid var(--border); border-radius:.9rem; padding:.9rem; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:.5rem; }
    .card-head { display:flex; align-items:center; gap:.6rem; }
    .station-name { font-weight:700; line-height:1.2; }
    .star { margin-left:auto; font-size:1.2rem; cursor:pointer; user-select:none; }
    .star[aria-pressed="true"] { filter: drop-shadow(0 0 6px color-mix(in oklab, var(--accent) 80%, transparent)); }

    .stats { display:flex; gap:.6rem; flex-wrap:wrap; }
    .chip { display:inline-flex; align-items:center; gap:.45rem; padding:.45rem .6rem; border-radius:.6rem; border:1px solid var(--border); background: color-mix(in oklab, var(--card) 90%, transparent); font-variant-numeric: tabular-nums; }
    .chip.ok { border-color: color-mix(in oklab, var(--ok) 45%, var(--border)); }
    .chip.warn { border-color: color-mix(in oklab, var(--warn) 55%, var(--border)); }
    .chip.bad { border-color: color-mix(in oklab, var(--bad) 55%, var(--border)); }

    .updated { color:var(--muted); font-size:.85rem; }
    .addr { color:var(--muted); font-size:.9rem; }
    .actions { display:inline-flex; gap:.6rem; flex-wrap:wrap; margin-top:.2rem; }
    .btn-link { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .55rem; border-radius:.55rem; border:1px solid var(--border); background: color-mix(in oklab, var(--card) 92%, transparent); text-decoration:none; color:var(--fg); box-shadow:var(--shadow); font-size:.92rem; }

    [data-view]{ display:none; }
    [data-view].active{ display:block; }

    footer { max-width:900px; margin:1rem auto 3rem; padding:0 1rem; color:var(--muted); font-size:.85rem; }

    .bottom-bar { position:fixed; left:0; right:0; bottom:0; z-index:12; display:none; background:var(--card); border-top:1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); }
    .bottom-bar .wrap { max-width:900px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr 1fr; }
    .bottom-bar button { appearance:none; border:none; background:transparent; color:var(--fg); padding:.6rem 0; font:inherit; cursor:pointer; }
    .bottom-bar .item { display:flex; flex-direction:column; align-items:center; gap:.25rem; padding:.5rem 0; }
    .bottom-bar .icon { font-size:1.1rem; line-height:1; }
    .bottom-bar .label { font-size:.75rem; opacity:.8; }

    @media (max-width:480px){
      .bar { padding:.6rem .6rem; }
      .title { max-width:56vw; font-size:.95rem; }
      .btn { padding:.45rem .6rem; font-size:.9rem; }
      .pill { display:none; }
      .logoCar { width:20px; height:20px; }
      .mobile-hide { display:none !important; }
      .bottom-bar { display:block; }
      main { padding-bottom:72px; }
      footer { margin-bottom: calc(72px + env(safe-area-inset-bottom)); }
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <svg class="logoCar" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="3" y="9" width="18" height="6" rx="2" ry="2"></rect>
        <circle cx="7" cy="17" r="3"></circle>
        <circle cx="17" cy="17" r="3"></circle>
        <path d="M6 9 L8 7 H16 L18 9"></path>
      </svg>
      <div class="title">Vite un Citiz&nbsp;!</div>

      <button id="btnHome"   class="btn mobile-hide" title="Accueil (favoris)">üè† Accueil</button>
      <span id="lastUpdate" class="pill" aria-live="polite">‚è±Ô∏é Maj ‚Äî ‚Ä¶</span>
      <button id="btnLocate" class="btn mobile-hide" title="Stations proches">üìç Autour de moi</button>

      <div class="spacer"></div>

      <button id="btnSearch" class="btn mobile-hide" title="Rechercher des stations">üîç Recherche</button>
      <button id="btnAbout"  class="btn" title="√Ä propos">‚ÑπÔ∏è √Ä propos</button>
    </div>
  </header>

  <!-- Filtres sous le header -->
  <div id="filters" class="filters" role="tablist" aria-label="Filtrer les stations">
    <button id="fltAll"   class="seg" role="tab" aria-selected="true"  data-mode="all">Tous</button>
    <button id="fltCars"  class="seg" role="tab" aria-selected="false" data-mode="cars">Voitures</button>
    <button id="fltSpots" class="seg" role="tab" aria-selected="false" data-mode="spots">Places</button>
  </div>

  <div id="ptr" class="ptr" role="status" aria-live="polite"><div class="wrap">‚Üª Glisse vers le bas pour actualiser</div></div>
  <div id="errorBanner" class="banner" role="status" aria-live="polite"><div class="wrap">‚ö†Ô∏è Impossible d‚Äôactualiser les donn√©es pour le moment. Derni√®res infos affich√©es.</div></div>

  <main>
    <section id="view-fav" data-view class="active" aria-labelledby="btnHome">
      <section id="nearby" class="nearby" hidden>
        <h2>√Ä proximit√©</h2>
        <div id="nearList" class="list" role="list"></div>
      </section>
      <div id="favList" class="list" role="list"></div>
      <div id="favEmpty" class="empty" hidden>
        Aucun favori pour l‚Äôinstant. Ouvre la recherche (üîç) pour en ajouter ‚≠ê.
      </div>
    </section>

    <section id="view-browse" data-view aria-labelledby="btnSearch">
      <div class="search">
        <div class="wrap">
          <input id="search" type="search" placeholder="Rechercher une station‚Ä¶ (filtre en direct)" aria-label="Rechercher une station" autocomplete="off" />
          <ul id="suggestions" class="suggestions" role="listbox" hidden></ul>
        </div>
      </div>
      <div id="allList" class="list" role="list" aria-live="polite"></div>
    </section>
  </main>

  <footer>
    <div>Source donn√©es : <a href="https://transport.data.gouv.fr/datasets/citiz-autopartage-hauts-de-france" target="_blank" rel="noopener">GBFS Citiz HDF</a>. Actualisation ~ 5 min. | Auteur : Dr. John</div>
  </footer>

  <nav class="bottom-bar" aria-label="Actions rapides">
    <div class="wrap">
      <button id="mbHome" class="item" title="Accueil (favoris)"><span class="icon">üè†</span><span class="label">Accueil</span></button>
      <button id="mbLocate" class="item" title="Autour de moi"><span class="icon">üìç</span><span class="label">Autour</span></button>
      <button id="mbSearch" class="item" title="Rechercher"><span class="icon">üîç</span><span class="label">Recherche</span></button>
    </div>
  </nav>

  <!-- √Ä propos: panel + backdrop -->
  <div id="aboutBackdrop" class="about-backdrop" hidden></div>
  <div id="aboutPanel" class="about-panel" role="dialog" aria-modal="true" aria-labelledby="aboutTitle" hidden>
    <div class="about-head">
      <div class="about-handle"></div>
      <h2 id="aboutTitle">√Ä propos</h2>
      <button id="aboutClose" class="btn about-close" aria-label="Fermer">‚úï</button>
    </div>
    <div class="about-body">
      <p><strong>Vite un Citiz !</strong> affiche rapidement les disponibilit√©s d‚Äôautopartage Citiz (voitures & places) et vos favoris. Donn√©es en temps quasi r√©el (GBFS Citiz).</p>
      <h3>L√©gendes & indications</h3>
      <ul>
        <li>üöó¬†Voitures disponibles ‚Äî v√©hicules libres √† la station.</li>
        <li>üÖøÔ∏è¬†Places libres ‚Äî emplacements disponibles pour retourner une voiture.</li>
        <li>Badges¬†: <em>Vide / Bient√¥t vide / Bient√¥t plein / Plein</em> selon les seuils.</li>
      </ul>
      <h3>Liens</h3>
      <p><a href="index.html">Retour au portail</a> ¬∑ <a href="https://transport.data.gouv.fr/resources/83157" target="_blank" rel="noopener">Ressource GBFS Citiz</a></p>
      <h3>Version</h3>
      <p id="aboutVersion">‚Äî</p>
      <p style="color:var(--muted)">Aucune donn√©e personnelle n‚Äôest collect√©e. Vos pr√©f√©rences restent dans votre navigateur (<code>localStorage</code>).</p>
    </div>
  </div>

  <style>
    /* About modal styles (kept at end for clarity) */
    .about-backdrop { position: fixed; inset: 0; background: color-mix(in oklab, var(--fg) 25%, transparent); backdrop-filter: blur(3px); z-index: 999; }
    .about-panel { position: fixed; left: 0; right: 0; bottom: 0; margin: 0; background: var(--card); border-top: 1px solid var(--border); border-radius: .9rem .9rem 0 0; box-shadow: var(--shadow); z-index: 1000; max-height: 85svh; transform: translateY(100%); opacity: 0; transition: transform 220ms ease, opacity 220ms ease; display: flex; flex-direction: column; }
    .about-panel.open { transform: translateY(0); opacity: 1; }
    .about-head { position: sticky; top: 0; background: var(--card); padding: .6rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: .6rem; }
    .about-handle { width: 36px; height: 4px; background: #9aa0a6; opacity: .8; border-radius: 999px; margin-right: .4rem; }
    .about-body { padding: .8rem 1rem calc(env(safe-area-inset-bottom) + 1rem); overflow: auto; }
    .about-close { margin-left: auto; }
    @media (min-width: 640px){ .about-panel { left:50%; right:auto; width:520px; bottom:auto; top:12vh; border-radius:.9rem; transform: translate(-50%, 10px); } .about-panel.open { transform: translate(-50%, 0); } }
  </style>

  <script>
    // ====== Constantes & √©tat ======
    const APP_VERSION = '2025.10.13.1';
    const GBFS_INDEX = 'https://backend.citiz.fr/public/provider/16/gbfs/v3.0/gbfs.json'; // HDF Citiz
    const GBFS_LANG = 'fr';

    const LS_KEYS = { fav: 'citiz_favorites', filter: 'citiz_filter' };
    const state = {
      stations: [],
      favorites: new Set(JSON.parse(localStorage.getItem(LS_KEYS.fav) || '[]')),
      timer: null,
      lastFetch: null,
      userLoc: null,
      trend: {},
      filter: localStorage.getItem(LS_KEYS.filter) || 'all',
    };

    /** @typedef {{ id:string, name:string, cars:number, spots:number, updatedAt:string, lat?:number, lon?:number, address?:string, is_installed?:number, is_renting?:number, is_returning?:number }} Station */

    const el = (sel, root=document) => root.querySelector(sel);
    const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const fmtTime = (iso) => { try { const d=new Date(iso); return new Intl.DateTimeFormat('fr-FR',{hour:'2-digit',minute:'2-digit'}).format(d);} catch{ return '‚Äî'; } };
    const unit = (n,sing,plur)=> (n===0||n===1? sing: plur);

    function saveFavorites(){ localStorage.setItem(LS_KEYS.fav, JSON.stringify([...state.favorites])); }

    function toRad(d){ return d*Math.PI/180; }
    function haversine(a,b){ if(!a||!b) return Infinity; const R=6371, dLat=toRad((b.lat||0)-(a.lat||0)), dLon=toRad((b.lon||0)-(a.lon||0)); const la1=toRad(a.lat||0), la2=toRad(b.lat||0); const x=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.min(1,Math.sqrt(x))); }

    function qtyClass(n){ if(n>=3) return 'ok'; if(n>=1) return 'warn'; return 'bad'; }

    function applyFilter(arr){ if(state.filter==='cars') return arr.filter(s=> (s.cars||0)>0); if(state.filter==='spots') return arr.filter(s=> (s.spots||0)>0); return arr; }
    function setFilter(mode){ state.filter=mode; localStorage.setItem(LS_KEYS.filter, mode); const map={all:'#fltAll', cars:'#fltCars', spots:'#fltSpots'}; for(const k of Object.keys(map)){ const b=el(map[k]); if(b) b.setAttribute('aria-selected', String(k===mode)); } render(); }

    function updateHeaderHeight(){ const h=document.querySelector('header'); if(h) document.documentElement.style.setProperty('--header-h', h.offsetHeight+'px'); }

    function haptic(ms=10){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch{} }

    function render(){
      el('#lastUpdate').textContent = `‚è±Ô∏é Maj ‚Äî ${state.lastFetch ? fmtTime(state.lastFetch) : '‚Äî'}`;

      const favContainer = el('#favList'); favContainer.innerHTML='';
      const favs = state.stations.filter(s=> state.favorites.has(s.id));

      const nearWrap = el('#nearby'); const nearList = el('#nearList');
      if(state.userLoc){
        const withGeo = state.stations.filter(s=> Number.isFinite(s.lat)&&Number.isFinite(s.lon));
        const nearby = withGeo.map(s=>({s, d:haversine(state.userLoc,{lat:s.lat,lon:s.lon})})).sort((a,b)=>a.d-b.d).slice(0,6).map(x=>x.s);
        nearList.innerHTML='';
        applyFilter(nearby).forEach(s=> nearList.appendChild(stationCard(s)));
        nearWrap.hidden = nearby.length===0;
      } else { nearWrap.hidden = true; }

      if(favs.length===0){ el('#favEmpty').hidden=false; } else { el('#favEmpty').hidden=true; favs.forEach(s=> favContainer.appendChild(stationCard(s))); }

      const allContainer = el('#allList'); const q=el('#search').value.trim().toLowerCase(); const filtered = q? state.stations.filter(s=> s.name.toLowerCase().includes(q)) : state.stations;
      allContainer.innerHTML='';
      applyFilter(filtered).forEach(s=> allContainer.appendChild(stationCard(s)));
      updateHeaderHeight();
    }

    function stationCard(s){
      const card=document.createElement('article'); card.className='card'; card.setAttribute('role','listitem');
      const head=document.createElement('div'); head.className='card-head';
      const name=document.createElement('div'); name.className='station-name'; name.textContent = s.name;
      if(state.userLoc && Number.isFinite(s.lat) && Number.isFinite(s.lon)){
        const distKm=haversine(state.userLoc,{lat:s.lat,lon:s.lon});
        const d=document.createElement('span'); d.className='distance'; d.textContent = `¬∑ ${distKm.toFixed(1)} km`; name.appendChild(d);
      }
      const star=document.createElement('button'); star.className='star'; star.type='button';
      const isFav=state.favorites.has(s.id); star.setAttribute('aria-pressed', String(isFav)); star.setAttribute('aria-label', isFav? 'Retirer des favoris':'Ajouter aux favoris'); star.textContent = isFav? '‚òÖ':'‚òÜ';
      star.addEventListener('click', ()=>{ if(state.favorites.has(s.id)) state.favorites.delete(s.id); else state.favorites.add(s.id); saveFavorites(); render(); });
      head.append(name, star);

      if(s.address){ const addr=document.createElement('div'); addr.className='addr'; addr.textContent=s.address; card.appendChild(addr); }

      const badges=[];
      if(s.is_installed===0) badges.push(badge('Hors service'));
      else if(s.is_renting===0 && s.is_returning===0) badges.push(badge('Ferm√©e'));
      if(s.spots===0) badges.push(badge('Plein')); else if(s.spots<=2) badges.push(badge('Bient√¥t plein'));
      if(s.cars===0) badges.push(badge('Vide')); else if(s.cars<=1) badges.push(badge('Bient√¥t vide'));
      function badge(t){ const b=document.createElement('span'); b.className='chip'; b.textContent=t; return b; }
      if(badges.length){ const row=document.createElement('div'); row.className='stats'; badges.forEach(x=>row.appendChild(x)); card.appendChild(row); }

      if(Number.isFinite(s.lat) && Number.isFinite(s.lon)){
        const actions=document.createElement('div'); actions.className='actions';
        const origin=(state.userLoc && Number.isFinite(state.userLoc.lat))? `&origin=${state.userLoc.lat},${state.userLoc.lon}`:'';
        const dest=`${s.lat},${s.lon}`;
        const gmaps=`https://www.google.com/maps/dir/?api=1&destination=${dest}${origin}&travelmode=walking`;
        const a1=document.createElement('a'); a1.href=gmaps; a1.target='_blank'; a1.rel='noopener'; a1.className='btn-link'; a1.textContent='üß≠ Itin√©raire';
        actions.append(a1); card.appendChild(actions);
      }

      const stats=document.createElement('div'); stats.className='stats';
      const cars=document.createElement('span'); cars.className=`chip ${qtyClass(s.cars)}`; cars.innerHTML = `üöó <strong>${s.cars}</strong> ${unit(s.cars,'voiture disponible','voitures disponibles')}`;
      const spots=document.createElement('span'); spots.className=`chip ${qtyClass(s.spots)}`; spots.innerHTML = `üÖøÔ∏è <strong>${s.spots}</strong> ${unit(s.spots,'place libre','places libres')}`;
      const upd=document.createElement('div'); upd.className='updated'; upd.textContent = `Derni√®re mise √† jour: ${fmtTime(s.updatedAt)}`;

      card.append(head, stats, cars, spots, upd);
      return card;
    }

    function setView(which){ const isFav = which==='fav'; el('#view-fav').classList.toggle('active', isFav); el('#view-browse').classList.toggle('active', !isFav); if(!isFav){ el('#search').focus({preventScroll:true}); el('#search').select(); } }

    async function fetchStations(){
      try{
        const idxRes = await fetch(GBFS_INDEX, { cache:'no-store' });
        const idx = await idxRes.json();
        let feeds = [];
        if (Array.isArray(idx.data?.feeds)) {
          feeds = idx.data.feeds;
        } else if (idx.data?.[GBFS_LANG]?.feeds) {
          feeds = idx.data[GBFS_LANG].feeds;
        } else {
          const first = Object.values(idx.data || {})[0];
          feeds = first?.feeds || [];
        }
        const infoUrl   = feeds.find(f=> f.name==='station_information')?.url;
        const statusUrl = feeds.find(f=> f.name==='station_status')?.url;
        // vehicle_status is optional; we stick to station_* like V'Lille for consistency
        if(!infoUrl || !statusUrl) throw new Error('Flux GBFS Citiz manquants');

        const [infoRes, statusRes] = await Promise.all([
          fetch(infoUrl, { cache:'no-store' }),
          fetch(statusUrl, { cache:'no-store' })
        ]);
        const [info, status] = await Promise.all([infoRes.json(), statusRes.json()]);

        const infoById = new Map();
        for(const s of (info.data?.stations || [])) infoById.set(String(s.station_id), s);

        const out=[];
        let updatedIso;
        const lu = status?.last_updated;
        if (typeof lu === 'number') updatedIso = new Date(lu * 1000).toISOString();
        else if (typeof lu === 'string') updatedIso = new Date(lu).toISOString();
        else updatedIso = new Date().toISOString();
        for(const st of (status.data?.stations || [])){
          const id = String(st.station_id);
          const i = infoById.get(id) || {};
          const cars  = Number(st.num_vehicles_available ?? st.num_bikes_available ?? 0);
          const spots = Number(st.num_parking_spots_available ?? st.num_docks_available ?? 0);
          out.push({
            id,
            name: i.name || `Station ${id}`,
            cars,
            spots,
            updatedAt: updatedIso,
            lat: Number(i.lat),
            lon: Number(i.lon),
            is_installed: Number(st.is_installed ?? 1),
            is_renting: Number(st.is_renting ?? 1),
            is_returning: Number(st.is_returning ?? 1),
            address: String(i.address || i.adresse || i.street_address || i.rue || '')
          });
        }
        out.sort((a,b)=> a.name.localeCompare(b.name,'fr'));
        state.stations = out; state.lastFetch = new Date().toISOString();
        el('#errorBanner').style.display='none';
        render();
      } catch(err){ console.error('Erreur GBFS Citiz', err); el('#errorBanner').style.display='block'; }
    }

    function startAutoRefresh(){ if(state.timer) clearInterval(state.timer); state.timer = setInterval(fetchStations, 300_000); } // 5 min

    // PTR
    let ptrStartY=0, ptrActive=false, ptrTriggered=false; const PTR_THRESHOLD=70;
    const showPTR=(m)=>{ const b=el('#ptr'); if(!b) return; b.querySelector('.wrap').textContent=m; b.classList.add('show'); };
    const hidePTR=()=>{ const b=el('#ptr'); if(!b) return; b.classList.remove('show'); };

    (function init(){
      // Th√®me auto
      const mediaTheme=window.matchMedia('(prefers-color-scheme: dark)');
      const applyTheme=()=> document.documentElement.setAttribute('data-theme', mediaTheme.matches? 'dark':'light');
      applyTheme(); mediaTheme.addEventListener('change', applyTheme);

      updateHeaderHeight(); window.addEventListener('resize', updateHeaderHeight);

      // Filtres
      setFilter(state.filter);
      el('#fltAll').addEventListener('click', ()=>{ haptic(); setFilter('all'); });
      el('#fltCars').addEventListener('click', ()=>{ haptic(); setFilter('cars'); });
      el('#fltSpots').addEventListener('click',()=>{ haptic(); setFilter('spots'); });

      // Nav
      el('#btnHome').addEventListener('click', ()=> setView('fav'));
      el('#btnSearch').addEventListener('click', ()=> setView('browse'));

      // √Ä propos
      const aboutBtn=el('#btnAbout'); const aboutPanel=el('#aboutPanel'); const aboutBackdrop=el('#aboutBackdrop'); const aboutClose=el('#aboutClose');
      const openAbout=()=>{ el('#aboutVersion').textContent=`Version¬†: ${APP_VERSION}`; aboutPanel.hidden=false; aboutBackdrop.hidden=false; requestAnimationFrame(()=> aboutPanel.classList.add('open')); };
      const closeAbout=()=>{ aboutPanel.classList.remove('open'); setTimeout(()=>{ aboutPanel.hidden=true; aboutBackdrop.hidden=true; },220); };
      aboutBtn.addEventListener('click', openAbout); aboutBackdrop.addEventListener('click', closeAbout); aboutClose.addEventListener('click', closeAbout);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !aboutPanel.hidden) closeAbout(); });

      // G√©oloc
      el('#btnLocate').addEventListener('click', ()=>{
        if(!('geolocation' in navigator)) return alert('G√©olocalisation non disponible.');
        navigator.geolocation.getCurrentPosition((pos)=>{ state.userLoc={lat:pos.coords.latitude, lon:pos.coords.longitude}; setView('fav'); render(); }, (err)=>{ console.warn('Geoloc',err); alert('Impossible de r√©cup√©rer la position.'); }, { enableHighAccuracy:true, timeout:8000, maximumAge:30000 });
      });

      // Recherche + suggestions
      el('#search').addEventListener('input', render);
      const sugg=el('#suggestions');
      el('#search').addEventListener('input', ()=>{
        const q=el('#search').value.trim().toLowerCase();
        if(!q){ sugg.hidden=true; sugg.innerHTML=''; render(); return; }
        const names=state.stations.map(s=>s.name).filter((v,i,a)=> a.indexOf(v)===i).filter(n=> n.toLowerCase().includes(q)).slice(0,8);
        sugg.innerHTML = names.map(n=> `<li role="option">${n.replace(/</g,'&lt;')}</li>`).join('');
        sugg.hidden = names.length===0;
      });
      el('#suggestions').addEventListener('mousedown', (e)=>{ const li=e.target.closest('li'); if(!li) return; el('#search').value=li.textContent; el('#suggestions').hidden=true; render(); });
      el('#search').addEventListener('blur', ()=> setTimeout(()=> el('#suggestions').hidden=true, 150));
      el('#search').addEventListener('focus', ()=>{ const q=el('#search').value.trim(); if(q) el('#search').dispatchEvent(new Event('input')); });

      // Pull-to-refresh
      window.addEventListener('touchstart', (e)=>{ if(window.scrollY===0){ ptrStartY=e.touches[0].clientY; ptrActive=true; ptrTriggered=false; showPTR('‚Üª Glisse vers le bas pour actualiser'); } }, {passive:true});
      window.addEventListener('touchmove', (e)=>{ if(!ptrActive) return; const dy=e.touches[0].clientY - ptrStartY; if(dy>PTR_THRESHOLD){ showPTR('Rel√¢cher pour actualiser'); ptrTriggered=true; } }, {passive:true});
      window.addEventListener('touchend', ()=>{ if(!ptrActive) return; ptrActive=false; if(ptrTriggered){ showPTR('Actualisation‚Ä¶'); fetchStations().finally(()=> hidePTR()); } else hidePTR(); });

      // Bottom bar
      const mbLocate=el('#mbLocate'); const mbSearch=el('#mbSearch'); const mbHome=el('#mbHome');
      if(mbHome) mbHome.addEventListener('click', ()=>{ haptic(); setView('fav'); });
      if(mbLocate) mbLocate.addEventListener('click', ()=>{ haptic(); el('#btnLocate')?.click(); });
      if(mbSearch) mbSearch.addEventListener('click', ()=>{ haptic(); setView('browse'); });

      // Go
      render(); fetchStations(); startAutoRefresh();
    })();
  </script>
</body>
</html>