<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vite un V'Lille !</title>
  <meta name="description" content="Disponibilit√© en temps r√©el des stations V'Lille ‚Äî favoris, recherche, th√®me sombre, sans rechargement." />
  <meta property="og:type" content="website">
  <meta property="og:locale" content="fr_FR">
  <meta property="og:site_name" content="Tempo Lille">
  <meta property="og:title" content="Vite un V'Lille !">
  <meta property="og:description" content="Disponibilit√© en temps r√©el des stations V'Lille ‚Äî favoris, recherche, th√®me sombre, sans rechargement.">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Vite un V'Lille !">
  <meta name="twitter:description" content="Disponibilit√© en temps r√©el des stations V'Lille ‚Äî favoris, recherche, th√®me sombre, sans rechargement.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
  <!-- Favicon & PWA meta -->
  <link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6" cy="17" r="4" fill="none" stroke="%23000" stroke-width="2"/><circle cx="18" cy="17" r="4" fill="none" stroke="%23000" stroke-width="2"/><path d="M6 17 L10 9 L12 13 L18 13" fill="none" stroke="%23000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 13 L14 17" fill="none" stroke="%23000" stroke-width="2" stroke-linecap="round"/></svg>'>
  <link rel="mask-icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6" cy="17" r="4" fill="%23000"/><circle cx="18" cy="17" r="4" fill="%23000"/><path d="M6 17 L10 9 L12 13 L18 13" fill="%23000"/><path d="M12 13 L14 17" fill="%23000"/></svg>' color="#0d6efd">
  <meta name="theme-color" content="#0d6efd" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Vite un V'Lille !" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --fg: #121212;
      --muted: #5a5a5a;
      --card: #f4f4f5;
      --accent: #0d6efd;
      --ok: #16a34a;   /* vert */
      --warn: #f59e0b; /* orange */
      --bad: #ef4444;  /* rouge */
      --border: #e5e7eb;
      --shadow: 0 1px 2px rgba(0,0,0,.06), 0 4px 12px rgba(0,0,0,.04);
    }
    html[data-theme="dark"] {
      --bg: #0b0b0c;
      --fg: #ececec;
      --muted: #b3b3b3;
      --card: #151518;
      --accent: #7aa2ff;
      --border: #22242a;
      --shadow: 0 1px 2px rgba(0,0,0,.4), 0 6px 20px rgba(0,0,0,.25);
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--fg); overflow-x: hidden; }

    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: blur(6px);
      background: color-mix(in oklab, var(--bg) 85%, transparent);
      border-bottom: 1px solid var(--border);
    }
    .bar { max-width: 900px; margin: 0 auto; padding: .8rem 1rem; display: flex; align-items: center; gap: .5rem; flex-wrap: wrap; }
    .logoBike {
      width: 24px; height: 24px; margin-right: .4rem; display: inline-block;
      stroke: var(--fg); fill: none; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round;
    }

    .title { font-weight: 800; letter-spacing: .2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 46vw; }
    .spacer { flex: 1; }
    .bar > * { max-width: 100%; }
    .pill { display: inline-flex; align-items: center; gap: .4rem; font-size: .9rem; padding: .35rem .6rem; border: 1px solid var(--border); border-radius: 999px; background: var(--card); }
    .btn { appearance: none; border: 1px solid var(--border); padding: .55rem .8rem; background: var(--card); color: var(--fg); border-radius: .7rem; box-shadow: var(--shadow); cursor: pointer; }
    .btn[aria-current="page"]{ outline: 2px solid var(--accent); }

    .banner { display: none; background: color-mix(in oklab, var(--bad) 18%, var(--bg)); color: var(--fg); border-bottom: 1px solid var(--border); }
    .banner .wrap { max-width: 900px; margin: 0 auto; padding: .5rem 1rem; display: flex; align-items: center; gap: .6rem; }

    .ptr { display:none; background: color-mix(in oklab, var(--accent) 12%, var(--bg)); border-bottom: 1px solid var(--border); }
    .ptr .wrap { max-width: 900px; margin: 0 auto; padding: .4rem 1rem; font-size: .9rem; }
    .ptr.show { display:block; }

    /* Filters segment */
    .filters { position: sticky; top: calc(var(--header-h, 56px)); z-index: 6; background: var(--bg); border-bottom: 1px solid var(--border); padding: .5rem 1rem; display: flex; gap: .4rem; justify-content: center; }
    .seg { appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--fg); padding: .45rem .8rem; border-radius: 999px; cursor: pointer; font: inherit; }
    .seg[aria-selected="true"] { outline: 2px solid var(--accent); }

    /* About modal */
    .about-backdrop { position: fixed; inset: 0; background: color-mix(in oklab, var(--fg) 25%, transparent); backdrop-filter: blur(3px); z-index: 999; }
    .about-panel { position: fixed; left: 0; right: 0; bottom: 0; margin: 0; background: var(--card); border-top: 1px solid var(--border); border-radius: .9rem .9rem 0 0; box-shadow: var(--shadow); z-index: 1000; max-height: 85svh; transform: translateY(100%); opacity: 0; transition: transform 220ms ease, opacity 220ms ease; display: flex; flex-direction: column; }
    .about-panel.open { transform: translateY(0); opacity: 1; }
    .about-head { position: sticky; top: 0; background: var(--card); padding: .6rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: .6rem; }
    .about-handle { width: 36px; height: 4px; background: #9aa0a6; opacity: .8; border-radius: 999px; margin-right: .4rem; }
    .about-body { padding: .8rem 1rem calc(env(safe-area-inset-bottom) + 1rem); overflow: auto; }
    .about-close { margin-left: auto; }

    @media (min-width: 640px){
      .about-panel { left: 50%; right: auto; width: 520px; bottom: auto; top: 12vh; border-radius: .9rem; transform: translate(-50%, 10px); }
      .about-panel.open { transform: translate(-50%, 0); }
    }

    main { max-width: 900px; margin: 0 auto; padding: 1rem; }

    /* Search */
    .search { position: sticky; top: var(--header-h, 56px); z-index: 5; background: var(--bg); padding: .6rem 0 .8rem; }
    .search .wrap { position: relative; }
    .suggestions { position: absolute; left: 0; right: 0; top: 100%; margin-top: .25rem; background: var(--card); border: 1px solid var(--border); border-radius: .7rem; box-shadow: var(--shadow); list-style: none; padding: .25rem 0; max-height: 280px; overflow: auto; }
    .suggestions[hidden] { display: none; }
    .suggestions li { padding: .55rem .9rem; cursor: pointer; }
    .suggestions li:hover { background: color-mix(in oklab, var(--card) 80%, var(--accent) 20%); }

    .nearby { margin-bottom: 1rem; }
    .nearby h2 { margin: 0 0 .5rem 0; font-size: 1rem; font-weight: 700; }
    .distance { margin-left: .35rem; font-size: .85rem; color: var(--muted); }
    .search input { width: 100%; padding: .8rem 1rem; border-radius: .7rem; border: 1px solid var(--border); background: var(--card); color: var(--fg); font-size: 1rem; }

    /* Cards list */
    .list { display: grid; grid-template-columns: 1fr; gap: .8rem; }
    @media (min-width: 640px){ .list { grid-template-columns: 1fr 1fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: .9rem; padding: .9rem; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: .5rem; }
    .card-head { display:flex; align-items: center; gap:.6rem; }
    .station-name { font-weight: 700; line-height: 1.2; }
    .star { margin-left: auto; font-size: 1.2rem; cursor: pointer; user-select: none; }
    .star[aria-pressed="true"] { filter: drop-shadow(0 0 6px color-mix(in oklab, var(--accent) 80%, transparent)); }

    .stats { display: flex; gap: .6rem; flex-wrap: wrap; }
    .chip { display: inline-flex; align-items: center; gap: .45rem; padding: .45rem .6rem; border-radius: .6rem; border: 1px solid var(--border); background: color-mix(in oklab, var(--card) 90%, transparent); font-variant-numeric: tabular-nums; }
    .chip.ok { border-color: color-mix(in oklab, var(--ok) 45%, var(--border)); }
    .chip.warn { border-color: color-mix(in oklab, var(--warn) 55%, var(--border)); }
    .chip.bad { border-color: color-mix(in oklab, var(--bad) 55%, var(--border)); }

    .updated { color: var(--muted); font-size: .85rem; }
    .addr { color: var(--muted); font-size: .9rem; }
    .actions { display: inline-flex; gap: .6rem; flex-wrap: wrap; margin-top: .2rem; }
    .btn-link { display: inline-flex; align-items: center; gap: .35rem; padding: .35rem .55rem; border-radius: .55rem; border: 1px solid var(--border); background: color-mix(in oklab, var(--card) 92%, transparent); text-decoration: none; color: var(--fg); box-shadow: var(--shadow); font-size: .92rem; }
    .btn-link:hover { filter: brightness(1.02); }
    .empty { padding: 1rem; border: 1px dashed var(--border); border-radius: .9rem; background: var(--card); }

    /* View toggling */
    [data-view] { display: none; }
    [data-view].active { display: block; }

    footer { max-width: 900px; margin: 1rem auto 3rem; padding: 0 1rem; color: var(--muted); font-size: .85rem; }
    a { color: var(--accent); }

    /* Bottom bar */
    .bottom-bar { position: fixed; left: 0; right: 0; bottom: 0; z-index: 12; display: none; background: var(--card); border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); }
    .bottom-bar .wrap { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr 1fr; }
    .bottom-bar a, .bottom-bar button { appearance: none; border: none; background: transparent; color: var(--fg); padding: .6rem 0; font: inherit; cursor: pointer; }
    .bottom-bar .item { display: flex; flex-direction: column; align-items: center; gap: .25rem; padding: .5rem 0; }
    .bottom-bar .icon { font-size: 1.1rem; line-height: 1; }
    .bottom-bar .label { font-size: .75rem; opacity: .8; }

    @media (max-width: 480px){
      .bar { padding: .6rem .6rem; }
      .title { max-width: 56vw; font-size: .95rem; }
      .btn { padding: .45rem .6rem; font-size: .9rem; }
      .pill { display: none; }
      .logoBike { width: 20px; height: 20px; }

      .mobile-hide { display: none !important; }
      .bottom-bar { display: block; }
      main { padding-bottom: 72px; }
      footer { margin-bottom: calc(72px + env(safe-area-inset-bottom)); }
    }
    /* ===== Tempo Lille navbar (light like page background) ===== */
    .tl-navbar {
      background: rgba(248, 250, 252, .94);
      backdrop-filter: blur(6px);
      box-shadow: 0 2px 14px rgba(0,0,0,.06);
      border: 1px solid rgba(13,110,253,.15);
      --bs-navbar-toggler-icon-bg: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(13,110,253,.9)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      --bs-navbar-color: #0d6efd;
      --bs-navbar-hover-color: #0a58ca;
    }
    html[data-theme="dark"] .tl-navbar {
      background: rgba(28,32,38,.92);
      box-shadow: 0 6px 22px rgba(0,0,0,.35);
      --bs-navbar-toggler-icon-bg: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255,255,255,.9)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      --bs-navbar-color: #e9eef8;
      --bs-navbar-hover-color: #fff;
    }
    .tl-navbar .navbar-brand,
    .tl-navbar .nav-link { color: #0d6efd !important; opacity:.95; transition: transform .12s ease, opacity .12s ease; }
    .tl-navbar .nav-link:hover,
    .tl-navbar .nav-link:focus { opacity:1; transform: translateY(-1px); background: rgba(13,110,253,.07); border-radius: .4rem; box-shadow: 0 1px 6px rgba(13,110,253,.1); }
    .tl-navbar .nav-link.active { font-weight:700; text-decoration: underline 2px; text-underline-offset:4px; }
    .navbar-toggler { border: 1px solid rgba(13,110,253,.35); border-radius:.6rem; padding:.35rem .6rem; }
    html[data-theme="dark"] .navbar-toggler { border-color: rgba(255,255,255,.5); }

    /* Subnav (local to V'Lille) */
    .tl-subnav { background: color-mix(in oklab, var(--bg) 96%, transparent); border-bottom: 1px solid var(--border); }
    .tl-subnav .form-control { max-width: 280px; }
    /* Subnav inline title */
    .tl-subnav .brand-inline { font-weight: 800; color: var(--muted); display: flex; align-items: center; gap: .5rem; }
    .tl-subnav .brand-inline .bi { font-size: 1rem; }
  </style>
  <link href="assets/tempo-ux.css" rel="stylesheet">
</head>
<body class="tempo-app tempo-vlille">
  <a class="tempo-skip-link" href="#main-content">Aller au contenu</a>
  <script src="assets/tempo-common.js"></script>
  <script>
    if (window.TempoCommon) window.TempoCommon.bindSystemTheme('data-theme');
  </script>
  <nav class="navbar navbar-expand-lg tl-navbar navbar-light sticky-top" aria-label="Menu principal">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html"><i class="bi bi-buildings me-2"></i>Tempo Lille</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#tlNav" aria-controls="tlNav" aria-expanded="false" aria-label="Basculer la navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="tlNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item"><a class="nav-link active" href="ViteVlille.html"><i class="bi bi-bicycle me-1"></i>V‚ÄôLille</a></li>
          <li class="nav-item"><a class="nav-link" href="metroilevia.html"><i class="bi bi-train-front me-1"></i>M√©tro Il√©via</a></li>
          <li class="nav-item"><a class="nav-link" href="airdelille.html"><i class="bi bi-cloud-sun me-1"></i>Air de Lille</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <nav class="tl-subnav" aria-label="Sous-menu V'Lille">
    <div class="container" style="max-width:900px;">
      <ul class="nav align-items-center gap-2 py-2 flex-wrap">
        <li class="nav-item"><span class="brand-inline"><i class="bi bi-bicycle"></i> Vite un V'Lille&nbsp;!</span></li>
        <li class="nav-item"><button id="subFav" type="button" class="btn btn-sm btn-outline-primary">‚≠ê Favoris</button></li>
        <li class="nav-item"><button id="subNear" type="button" class="btn btn-sm btn-outline-primary">üìç Autour de moi</button></li>
        <li class="nav-item d-flex align-items-center gap-2">
          <i class="bi bi-search"></i>
          <input id="subSearch" type="search" class="form-control form-control-sm" placeholder="Rechercher une station‚Ä¶">
        </li>
        <li class="nav-item ms-auto"><span id="lastUpdate" class="pill">‚è±Ô∏é Maj ‚Äî ‚Ä¶</span></li>
      </ul>
    </div>
  </nav>


  <!-- Filtres sous le header -->
  <div id="filters" class="filters" role="tablist" aria-label="Filtrer les stations">
    <button id="fltAll"   class="seg" role="tab" aria-selected="true"  data-mode="all">Tous</button>
    <button id="fltBikes" class="seg" role="tab" aria-selected="false" data-mode="bikes">V√©los</button>
    <button id="fltDocks" class="seg" role="tab" aria-selected="false" data-mode="docks">Places</button>
  </div>

  <div id="ptr" class="ptr" role="status" aria-live="polite"><div class="wrap">‚Üª Glisse vers le bas pour actualiser</div></div>

  <div id="errorBanner" class="banner" role="status" aria-live="polite">
    <div class="wrap">‚ö†Ô∏è Impossible d‚Äôactualiser les donn√©es pour le moment. Derni√®res infos affich√©es.</div>
  </div>

  <main id="main-content">
    <section class="tempo-page-head mb-3" aria-label="Pr√©sentation de l'application">
      <p class="eyebrow">V'Lille Temps R√©el</p>
      <h1 class="h5 mb-1">Trouver une station en quelques secondes</h1>
      <p class="mb-0 tempo-muted">Favoris, stations autour de vous et recherche instantan√©e sans rechargement.</p>
    </section>
    <!-- Vue 1 : Favoris -->
    <section id="view-fav" data-view class="active" aria-labelledby="view-fav-title">
      <h2 id="view-fav-title" class="visually-hidden">Stations favorites</h2>
      <section id="nearby" class="nearby" hidden>
        <h2>√Ä proximit√©</h2>
        <div id="nearList" class="list" role="list"></div>
      </section>
      <div id="favList" class="list" role="list"></div>
      <div id="favEmpty" class="empty" hidden>
        Aucune station en favori pour l'instant. Ouvre la recherche (üîç) pour en ajouter ‚≠ê.
      </div>
    </section>

    <!-- Vue 2 : Recherche / Ajout -->
    <section id="view-browse" data-view aria-labelledby="view-browse-title">
      <h2 id="view-browse-title" class="visually-hidden">Recherche de stations</h2>
      <div class="search">
        <div class="wrap">
          <input id="search" type="search" placeholder="Rechercher une station‚Ä¶ (filtre en direct)" aria-label="Rechercher une station" autocomplete="off" />
          <ul id="suggestions" class="suggestions" role="listbox" hidden></ul>
        </div>
      </div>
      <div id="allList" class="list" role="list" aria-live="polite"></div>
    </section>
  </main>

  <footer>
    <div>Source donn√©es : <a href="https://transport.data.gouv.fr/datasets/vlille-disponibilite-en-temps-reel-3" target="_blank" rel="noopener">GBFS Il√©via (V'Lille)</a>. Actualisation ~ 60 s. | Build publie le 17/02/2026 a 17:20 (Europe/Paris) - Version 2026-02-17-1720</div>
  </footer>

  <nav class="bottom-bar" aria-label="Actions rapides">
    <div class="wrap">
      <button id="mbHome" class="item" title="Favoris">
        <span class="icon">‚≠ê</span>
        <span class="label">Favoris</span>
      </button>
      <button id="mbLocate" class="item" title="Autour de moi">
        <span class="icon">üìç</span>
        <span class="label">Autour</span>
      </button>
      <button id="mbSearch" class="item" title="Rechercher">
        <span class="icon">üîç</span>
        <span class="label">Recherche</span>
      </button>
    </div>
  </nav>

  <!-- √Ä propos: panel + backdrop -->
  <div id="aboutBackdrop" class="about-backdrop" hidden></div>
  <div id="aboutPanel" class="about-panel" role="dialog" aria-modal="true" aria-labelledby="aboutTitle" hidden>
    <div class="about-head">
      <div class="about-handle"></div>
      <h2 id="aboutTitle">√Ä propos</h2>
      <button id="aboutClose" class="btn about-close" aria-label="Fermer">‚úï</button>
    </div>
    <div class="about-body">
      <p><strong>Vite un V'Lille !</strong> affiche rapidement les disponibilit√©s des stations V'Lille (v√©los & places) et vos favoris. Donn√©es en temps quasi r√©el (GBFS Il√©via).
      </p>
      <h3>L√©gendes & indications</h3>
      <ul>
        <li>üö≤¬†V√©los disponibles ‚Äî nombre de v√©los pr√™ts √† partir.</li>
        <li>üÖøÔ∏è¬†Places vacantes ‚Äî nombre d‚Äôemplacements libres pour retourner un v√©lo.</li>
        <li>Badges¬†: <em>Vide / Bient√¥t vide / Bient√¥t plein / Plein</em> selon les seuils internes.</li>
      </ul>
      <h3>Liens</h3>
      <p><a href="index.html">Retour au portail</a> ¬∑ <a href="https://transport.data.gouv.fr/datasets/vlille-disponibilite-en-temps-reel-3" target="_blank" rel="noopener">Source GBFS</a></p>
      <h3>Version</h3>
      <p id="aboutVersion">‚Äî</p>
      <p style="color:var(--muted)">Aucune donn√©e personnelle n‚Äôest collect√©e. Vos pr√©f√©rences (favoris) restent dans votre navigateur (<code>localStorage</code>).
      </p>
    </div>
  </div>

  <script>
    // ====== Constantes & √©tat ======
    const GBFS_INDEX = 'https://media.ilevia.fr/opendata/gbfs.json';
    const GBFS_LANG = 'fr'; // fallback to first available if missing

    const APP_VERSION = '2025.10.13.1';

    const LS_KEYS = { fav: 'vlille_favorites', filter: 'vlille_filter' };

    const state = {
      stations: /** @type {Array<Station>} */([]),
      favorites: new Set(JSON.parse(localStorage.getItem(LS_KEYS.fav) || '[]')),
      timer: null,
      lastFetch: null,
      userLoc: null,
      sort: localStorage.getItem('vlille_sort') || 'bikes',
      thr: JSON.parse(localStorage.getItem('vlille_thr') || '{"empty":2,"full":2}'),
      sortAuto: JSON.parse(localStorage.getItem('vlille_sort_auto') || 'true'),
      trend: {},
      filter: localStorage.getItem(LS_KEYS.filter) || 'all',
    };

    /** @typedef {{ id:string, name:string, bikes:number, docks:number, updatedAt:string, lat?:number, lon?:number, address?:string }} Station */

    // ====== Utilitaires ======
    const el = (sel, root=document) => root.querySelector(sel);
    const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const fmtTime = (iso) => {
      try { const d = new Date(iso); return new Intl.DateTimeFormat('fr-FR', { hour: '2-digit', minute: '2-digit' }).format(d); } catch { return '‚Äî'; }
    };

    function saveFavorites(){ localStorage.setItem(LS_KEYS.fav, JSON.stringify([...state.favorites])); }
    function saveSort(){ localStorage.setItem('vlille_sort', state.sort); }
    function saveThr(){ localStorage.setItem('vlille_thr', JSON.stringify(state.thr)); }
    function saveSortAuto(){ localStorage.setItem('vlille_sort_auto', JSON.stringify(state.sortAuto)); }
    function loadHistory(){
      try { return JSON.parse(localStorage.getItem('vlille_hist') || '{"ts":0,"data":{}}'); } catch { return { ts:0, data:{} }; }
    }
    function saveHistory(snapshot){ localStorage.setItem('vlille_hist', JSON.stringify(snapshot)); }

    function qtyClass(n){
      if (n >= 5) return 'ok';
      if (n >= 1) return 'warn';
      return 'bad';
    }
    function unit(n, singular, plural){ return (n === 0 || n === 1) ? singular : plural; }

    function applyFilter(arr){
      if (state.filter === 'bikes') return arr.filter(s => (s.bikes||0) > 0);
      if (state.filter === 'docks') return arr.filter(s => (s.docks||0) > 0);
      return arr;
    }
    function setFilter(mode){
      state.filter = mode; localStorage.setItem(LS_KEYS.filter, mode);
      // Update segment aria-selected
      const map = { all: '#fltAll', bikes: '#fltBikes', docks: '#fltDocks' };
      for (const k of Object.keys(map)){
        const btn = el(map[k]); if (!btn) continue;
        btn.setAttribute('aria-selected', String(k === mode));
      }
      render();
    }

    function toRad(d){ return d * Math.PI / 180; }
    function haversine(a, b){
      if (!a || !b) return Infinity;
      const R = 6371; // km
      const dLat = toRad((b.lat||0) - (a.lat||0));
      const dLon = toRad((b.lon||0) - (a.lon||0));
      const la1 = toRad(a.lat||0); const la2 = toRad(b.lat||0);
      const x = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.min(1, Math.sqrt(x)));
    }

    function sortStations(arr){
      const auto = state.sortAuto && state.userLoc;
      const mode = auto ? 'distance' : state.sort;
      if (mode === 'bikes') return [...arr].sort((a,b)=> b.bikes - a.bikes || a.name.localeCompare(b.name,'fr'));
      if (mode === 'docks') return [...arr].sort((a,b)=> b.docks - a.docks || a.name.localeCompare(b.name,'fr'));
      if (mode === 'distance' && state.userLoc) return [...arr].sort((a,b)=> haversine(state.userLoc, {lat:a.lat,lon:a.lon}) - haversine(state.userLoc, {lat:b.lat,lon:b.lon}));
      return [...arr].sort((a,b)=> a.name.localeCompare(b.name,'fr'));
    }

    function updateTrends(newStations){
      const prev = loadHistory();
      const now = Date.now();
      const within = (now - (prev.ts||0)) <= 60*60*1000; // 60 min
      const prevMap = within ? (prev.data || {}) : {};
      const trend = {};
      for (const s of newStations){
        const p = prevMap[s.id];
        if (p){
          trend[s.id] = {
            bikes: Math.sign((s.bikes||0) - (p.bikes||0)),
            docks: Math.sign((s.docks||0) - (p.docks||0))
          };
        }
      }
      state.trend = trend;
      const snap = { ts: now, data: Object.fromEntries(newStations.map(s=> [s.id, { bikes: s.bikes, docks: s.docks }])) };
      saveHistory(snap);
    }

    function updateHeaderHeight(){
      const mainNav = document.querySelector('.tl-navbar');
      const subNav = document.querySelector('.tl-subnav');
      const filters = document.querySelector('#filters');
      if (mainNav) document.documentElement.style.setProperty('--nav-main-h', mainNav.offsetHeight + 'px');
      const headerHeight = (mainNav ? mainNav.offsetHeight : 0) + (subNav ? subNav.offsetHeight : 0);
      if (headerHeight > 0) document.documentElement.style.setProperty('--header-h', headerHeight + 'px');
      if (filters) document.documentElement.style.setProperty('--filters-h', filters.offsetHeight + 'px');
    }

    // Haptique l√©ger (mobile)
    function haptic(ms = 10){ try { if (navigator.vibrate) navigator.vibrate(ms); } catch {} }

    // G√©olocalisation partag√©e (subnav + mobile bar)
    window.requestVLilleLocation = function(){
      if (!('geolocation' in navigator)) { alert("G√©olocalisation non disponible sur cet appareil."); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        state.userLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        setView('fav');
        render();
      }, (err)=>{
        console.warn('Geoloc error', err);
        alert("Impossible de r√©cup√©rer la position.");
      }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 30_000 });
    }

    // ====== Rendu ======
    function render(){
      // Derni√®re maj (header)
      el('#lastUpdate').textContent = `‚è±Ô∏é Maj ‚Äî ${state.lastFetch ? fmtTime(state.lastFetch) : '‚Äî'}`;

      // Vue Favoris
      const favContainer = el('#favList');
      favContainer.innerHTML = '';
      const favs = state.stations.filter(s => state.favorites.has(s.id));

      // Nearby
      const nearWrap = el('#nearby');
      const nearList = el('#nearList');
      if (state.userLoc) {
        const withGeo = state.stations.filter(s => Number.isFinite(s.lat) && Number.isFinite(s.lon));
        const nearby = withGeo
          .map(s => ({ s, d: haversine(state.userLoc, {lat:s.lat, lon:s.lon}) }))
          .sort((a,b)=> a.d - b.d)
          .slice(0, 6)
          .map(x => x.s);
        nearList.innerHTML = '';
        applyFilter(nearby).forEach(s => nearList.appendChild(stationCard(s)));
        nearWrap.hidden = applyFilter(nearby).length === 0;
      } else {
        nearWrap.hidden = true;
      }

      if (favs.length === 0) {
        el('#favEmpty').hidden = false;
      } else {
        el('#favEmpty').hidden = true;
        // Favoris : n'applique pas le filtre pour √©viter l'effet "disparu" apr√®s ajout
        sortStations(favs).forEach(s => favContainer.appendChild(stationCard(s)));
        if (state.filter !== 'all') {
          const hiddenCount = applyFilter(favs).length - favs.length; // negative value
          if (hiddenCount !== 0) {
            const note = document.createElement('div');
            note.className = 'updated';
            note.textContent = 'Astuce : le filtre n\'est pas appliqu√© aux favoris pour √©viter de masquer vos stations.';
            favContainer.parentElement.insertBefore(note, favContainer.nextSibling);
          }
        }
      }

      // Vue Parcourir (filtr√©e)
      const allContainer = el('#allList');
      const q = el('#search').value.trim().toLowerCase();
      const filtered = q ? state.stations.filter(s => s.name.toLowerCase().includes(q)) : state.stations;
      allContainer.innerHTML = '';
      sortStations(applyFilter(filtered)).forEach(s => allContainer.appendChild(stationCard(s)));
      updateHeaderHeight();
      // No-op placeholder: sticky search already uses --header-h; filters are stacked visually.
    }

    function stationCard(s){
      const card = document.createElement('article');
      card.className = 'card';
      card.setAttribute('role','listitem');

      const head = document.createElement('div');
      head.className = 'card-head';
      const name = document.createElement('div');
      name.className = 'station-name';
      name.textContent = s.name;
      if (state.userLoc && Number.isFinite(s.lat) && Number.isFinite(s.lon)){
        const distKm = haversine(state.userLoc, {lat: s.lat, lon: s.lon});
        const d = document.createElement('span');
        d.className = 'distance';
        d.textContent = `¬∑ ${distKm.toFixed(1)} km`;
        name.appendChild(d);
      }

      const star = document.createElement('button');
      star.className = 'star';
      star.type = 'button';
      const isFav = state.favorites.has(s.id);
      star.setAttribute('aria-pressed', String(isFav));
      star.setAttribute('aria-label', isFav ? 'Retirer des favoris' : 'Ajouter aux favoris');
      star.textContent = isFav ? '‚òÖ' : '‚òÜ';
      star.addEventListener('click', () => {
        if (state.favorites.has(s.id)) state.favorites.delete(s.id); else state.favorites.add(s.id);
        saveFavorites();
        render();
      });

      head.append(name, star);

      // Adresse (si disponible)
      if (s.address) {
        const addr = document.createElement('div');
        addr.className = 'addr';
        addr.textContent = s.address;
        card.appendChild(addr);
      }

      // Badges d‚Äô√©tat
      const badges = [];
      if (s.is_installed === 0) badges.push(badge('Hors service'));
      else if (s.is_renting === 0 && s.is_returning === 0) badges.push(badge('Ferm√©e'));

      if (s.docks === 0) badges.push(badge('Plein'));
      else if (s.docks <= state.thr.full) badges.push(badge('Bient√¥t plein'));

      if (s.bikes === 0) badges.push(badge('Vide'));
      else if (s.bikes <= state.thr.empty) badges.push(badge('Bient√¥t vide'));

      function badge(txt){ const b=document.createElement('span'); b.className='chip'; b.textContent=txt; return b; }
      if (badges.length){ const row=document.createElement('div'); row.className='stats'; badges.forEach(x=>row.appendChild(x)); card.appendChild(row); }

      // Itin√©raire Google Maps
      if (Number.isFinite(s.lat) && Number.isFinite(s.lon)){
        const actions = document.createElement('div');
        actions.className = 'actions';
        const origin = (state.userLoc && Number.isFinite(state.userLoc.lat)) ? `&origin=${state.userLoc.lat},${state.userLoc.lon}` : '';
        const dest = `${s.lat},${s.lon}`;
        const gmaps = `https://www.google.com/maps/dir/?api=1&destination=${dest}${origin}&travelmode=walking`;
        const a1 = document.createElement('a'); a1.href = gmaps; a1.target = '_blank'; a1.rel = 'noopener'; a1.className = 'btn-link'; a1.textContent = 'üß≠ Itin√©raire';
        actions.append(a1);
        card.appendChild(actions);
      }

      const stats = document.createElement('div');
      stats.className = 'stats';

      const bikes = document.createElement('span');
      bikes.className = `chip ${qtyClass(s.bikes)}`;
      bikes.append(document.createTextNode('üö≤ '));
      const bikesValue = document.createElement('strong');
      bikesValue.textContent = String(s.bikes);
      bikes.appendChild(bikesValue);
      bikes.append(document.createTextNode(` ${unit(s.bikes,'v√©lo disponible','v√©los disponibles')}`));
      const tb = state.trend[s.id]?.bikes || 0;
      if (tb !== 0){
        const arrow = document.createElement('span');
        arrow.style.marginLeft = '.25rem';
        arrow.textContent = tb > 0 ? '‚Üë' : '‚Üì';
        bikes.appendChild(arrow);
      }

      const docks = document.createElement('span');
      docks.className = `chip ${qtyClass(s.docks)}`;
      docks.append(document.createTextNode('üÖøÔ∏è '));
      const docksValue = document.createElement('strong');
      docksValue.textContent = String(s.docks);
      docks.appendChild(docksValue);
      docks.append(document.createTextNode(` ${unit(s.docks,'place vacante','places vacantes')}`));
      const td = state.trend[s.id]?.docks || 0;
      if (td !== 0){
        const arrow = document.createElement('span');
        arrow.style.marginLeft = '.25rem';
        arrow.textContent = td > 0 ? '‚Üë' : '‚Üì';
        docks.appendChild(arrow);
      }

      const upd = document.createElement('div');
      upd.className = 'updated';
      upd.textContent = `Derni√®re mise √† jour: ${fmtTime(s.updatedAt)}`;

      card.append(head, stats, bikes, docks, upd);
      return card;
    }

    // ====== Navigation de vues ======
    function setView(which){
      const isFavView = which === 'fav';
      el('#view-fav').classList.toggle('active', isFavView);
      el('#view-browse').classList.toggle('active', !isFavView);
      if (!isFavView) el('#search').focus({ preventScroll: true });
      if (!isFavView) el('#search').select();
    }

    // ====== GBFS: r√©cup√©ration fusionn√©e ======
    async function fetchStations(){
      try {
        const idxRes = await fetch(GBFS_INDEX, { cache: 'no-store' });
        const idx = await idxRes.json();
        const feeds = (idx.data?.[GBFS_LANG]?.feeds)
          || idx.data?.[Object.keys(idx.data || {})[0]]?.feeds
          || [];
        const infoUrl   = feeds.find(f => f.name === 'station_information')?.url;
        const statusUrl = feeds.find(f => f.name === 'station_status')?.url;
        if (!infoUrl || !statusUrl) throw new Error('Flux GBFS manquants');

        const [infoRes, statusRes] = await Promise.all([
          fetch(infoUrl, { cache: 'no-store' }),
          fetch(statusUrl, { cache: 'no-store' })
        ]);
        const [info, status] = await Promise.all([infoRes.json(), statusRes.json()]);

        const infoById = new Map();
        for (const s of (info.data?.stations || [])) infoById.set(String(s.station_id), s);

        const out = [];
        for (const st of (status.data?.stations || [])){
          const id = String(st.station_id);
          const i = infoById.get(id) || {};
          out.push({
            id,
            name: i.name || `Station ${id}`,
            bikes: Number(st.num_bikes_available ?? 0),
            docks: Number(st.num_docks_available ?? 0),
            updatedAt: (status?.last_updated ? new Date(status.last_updated*1000).toISOString() : new Date().toISOString()),
            lat: Number(i.lat),
            lon: Number(i.lon),
            is_installed: Number(st.is_installed ?? 1),
            is_renting: Number(st.is_renting ?? 1),
            is_returning: Number(st.is_returning ?? 1),
            address: String(i.address || i.adresse || i.street_address || i.rue || '')
          });
        }

        out.sort((a,b)=> a.name.localeCompare(b.name, 'fr'));
        state.stations = out;
        updateTrends(out);
        state.lastFetch = new Date().toISOString();
        el('#errorBanner').style.display = 'none';
        render();
      } catch (err){
        console.error('Erreur GBFS', err);
        el('#errorBanner').style.display = 'block';
      }
    }

    // ====== Auto-refresh ======
    function startAutoRefresh(){
      if (state.timer) clearInterval(state.timer);
      state.timer = setInterval(fetchStations, 60_000); // 60s
    }

    // ====== Pull-to-refresh (mobile) ======
    let ptrStartY = 0, ptrActive = false, ptrTriggered = false;
    const PTR_THRESHOLD = 70;
    function showPTR(msg){ const b=el('#ptr'); if(!b) return; b.querySelector('.wrap').textContent = msg; b.classList.add('show'); }
    function hidePTR(){ const b=el('#ptr'); if(!b) return; b.classList.remove('show'); }

    (function init(){
      // Header layout helpers
      updateHeaderHeight();
      window.addEventListener('resize', updateHeaderHeight);

      // Init filters segment
      setFilter(state.filter);
      el('#fltAll').addEventListener('click',   ()=> { if (typeof haptic==='function') haptic(); setFilter('all'); });
      el('#fltBikes').addEventListener('click', ()=> { if (typeof haptic==='function') haptic(); setFilter('bikes'); });
      el('#fltDocks').addEventListener('click', ()=> { if (typeof haptic==='function') haptic(); setFilter('docks'); });

      // Recherche + suggestions
      el('#search').addEventListener('input', render);
      const sugg = el('#suggestions');
      el('#search').addEventListener('input', ()=>{
        const q = el('#search').value.trim().toLowerCase();
        if (!q) { sugg.hidden = true; sugg.textContent = ''; render(); return; }
        const names = state.stations
          .map(s => s.name)
          .filter((v,i,arr)=> arr.indexOf(v)===i)
          .filter(n => n.toLowerCase().includes(q))
          .slice(0, 8);
        sugg.textContent = '';
        for (const n of names) {
          const li = document.createElement('li');
          li.setAttribute('role', 'option');
          li.textContent = n;
          sugg.appendChild(li);
        }
        sugg.hidden = names.length === 0;
      });
      el('#suggestions').addEventListener('mousedown', (e)=>{
        const li = e.target.closest('li');
        if (!li) return;
        el('#search').value = li.textContent;
        el('#suggestions').hidden = true;
        render();
      });
      el('#search').addEventListener('blur', ()=> setTimeout(()=> el('#suggestions').hidden = true, 150));
      el('#search').addEventListener('focus', ()=>{
        const q = el('#search').value.trim();
        if (q) el('#search').dispatchEvent(new Event('input'));
      });

      // √Ä propos (sheet) ‚Äî robust lazy binding
      const aboutBtn = el('#btnAbout');
      const openAbout = ()=>{
        const aboutPanel = el('#aboutPanel');
        const aboutBackdrop = el('#aboutBackdrop');
        const aboutClose = el('#aboutClose');
        const ver = el('#aboutVersion');
        if (ver) ver.textContent = `Version¬†: ${APP_VERSION}`;
        if (!aboutPanel || !aboutBackdrop) return;
        aboutPanel.hidden = false; aboutBackdrop.hidden = false;
        requestAnimationFrame(()=> aboutPanel.classList.add('open'));
        const onEsc = (e)=>{ if (e.key === 'Escape') close(); };
        function close(){
          aboutPanel.classList.remove('open');
          setTimeout(()=> { aboutPanel.hidden = true; aboutBackdrop.hidden = true; document.removeEventListener('keydown', onEsc); }, 220);
        }
        aboutBackdrop.addEventListener('click', close, { once: true });
        if (aboutClose) aboutClose.addEventListener('click', close, { once: true });
        document.addEventListener('keydown', onEsc);
      };
      if (aboutBtn) aboutBtn.addEventListener('click', openAbout);

      // Pull-to-refresh
      window.addEventListener('touchstart', (e)=>{
        if (window.scrollY === 0) { ptrStartY = e.touches[0].clientY; ptrActive = true; ptrTriggered = false; showPTR('‚Üª Glisse vers le bas pour actualiser'); }
      }, { passive: true });
      window.addEventListener('touchmove', (e)=>{
        if (!ptrActive) return;
        const dy = e.touches[0].clientY - ptrStartY;
        if (dy > PTR_THRESHOLD) { showPTR('Rel√¢cher pour actualiser'); ptrTriggered = true; }
      }, { passive: true });
      window.addEventListener('touchend', ()=>{
        if (!ptrActive) return; ptrActive = false;
        if (ptrTriggered) { showPTR('Actualisation‚Ä¶'); fetchStations().finally(()=> hidePTR()); }
        else { hidePTR(); }
      });

      // Bottom bar (mobile)
      const mbLocate = el('#mbLocate');
      const mbSearch = el('#mbSearch');
      const mbHome   = el('#mbHome');

      if (mbHome)   mbHome.addEventListener('click', ()=> { if (typeof haptic==='function') haptic(); setView('fav'); });
      if (mbLocate) mbLocate.addEventListener('click', ()=> { if (typeof haptic==='function') haptic(); window.requestVLilleLocation?.(); });
      if (mbSearch) mbSearch.addEventListener('click', ()=> { if (typeof haptic==='function') haptic(); setView('browse'); });

      // Premier rendu + donn√©es
      render();
      fetchStations();
      startAutoRefresh();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    if (window.TempoCommon) window.TempoCommon.bindMobileNavCollapse();

    // Sous-menu V'Lille : actions
    (function(){
      const btnFav = document.getElementById('subFav');
      const btnNear = document.getElementById('subNear');
      const subSearch = document.getElementById('subSearch');
      if (btnFav) btnFav.addEventListener('click', ()=> { if (typeof setView==='function') setView('fav'); });
      if (btnNear) btnNear.addEventListener('click', ()=> { window.requestVLilleLocation?.(); });
      if (subSearch) {
        const mainSearch = document.getElementById('search');
        subSearch.addEventListener('input', ()=> {
          if (!mainSearch) return;
          mainSearch.value = subSearch.value;
          if (typeof setView==='function') setView('browse');
          mainSearch.dispatchEvent(new Event('input', { bubbles: true }));
        });
      }
    })();
  </script>
</body>
</html>
